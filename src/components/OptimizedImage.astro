---
import { Image } from 'astro:assets';
import path from 'path';

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
}

const { src, alt, width = 600, height = 600, class: className } = Astro.props;

// Handle both local and remote images
const isRemote = src.startsWith('http://') || src.startsWith('https://') || src.startsWith('/');

// For local images, check if WebP version exists
let finalSrc = src;
if (!isRemote && typeof src === 'string') {
  const ext = path.extname(src);
  const basePath = src.replace(ext, '');
  const webpPath = `${basePath}.webp`;
  
  // Try to use WebP version if it exists
  try {
    const images = import.meta.glob('/src/assets/**/*.{jpg,jpeg,png,webp}', { eager: false });
    const webpKey = Object.keys(images).find(key => key.endsWith(webpPath.replace('/src', '')));
    if (webpKey) {
      finalSrc = webpPath;
    }
  } catch (e) {
    // Fallback to original if WebP check fails
  }
}
---

{isRemote ? (
  <img
    src={src}
    alt={alt}
    width={width}
    height={height}
    loading="lazy"
    decoding="async"
    class={className}
    style="max-width: 600px; width: 100%; height: auto; object-fit: contain; margin: 1.5rem auto; display: block; border-radius: 0.75rem;"
  />
) : (
  <Image
    src={finalSrc}
    alt={alt}
    width={width}
    height={height}
    format="webp"
    quality={70}
    loading="lazy"
    decoding="async"
    class={className}
    sizes="(max-width: 640px) 100vw, 600px"
  />
)}